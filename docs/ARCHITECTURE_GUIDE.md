# 🏗️ クリーンアーキテクチャ + DDD 実装ガイド

## 📖 このプロジェクトで学べること

### 1. 🎯 クリーンアーキテクチャの基本構造

```
外側 ← 依存の向き ← 内側

┌─────────────────────────────────────┐
│ インフラ層 (Infrastructure)          │
│ - EloquentBookRepository            │
│ - BookModel                         │
│ - データベース、外部API              │
└─────────────────────────────────────┘
           ↑ 依存
┌─────────────────────────────────────┐
│ プレゼンテーション層                 │
│ - BookController                    │
│ - HTTPリクエスト/レスポンス          │
└─────────────────────────────────────┘
           ↑ 依存
┌─────────────────────────────────────┐
│ アプリケーション層                   │
│ - RegisterBookUseCase               │
│ - Command/Response                  │
└─────────────────────────────────────┘
           ↑ 依存
┌─────────────────────────────────────┐
│ ドメイン層 (Domain) ← 中心！         │
│ - Book (エンティティ)                │
│ - BookId, Title (値オブジェクト)     │
│ - BookRepositoryInterface           │
└─────────────────────────────────────┘
```

### 2. 🔄 依存性逆転の原則

**従来の設計（悪い例）:**
```
コントローラー → サービス → リポジトリ実装 → データベース
```

**クリーンアーキテクチャ（良い例）:**
```
コントローラー → ユースケース → リポジトリインターフェース ← リポジトリ実装
                                      ↑                    ↓
                                 ドメイン層              インフラ層
```

### 3. 🏷️ DDDの重要な概念

#### エンティティ (Entity)
- **特徴**: 一意のIDを持つ、ライフサイクルがある
- **例**: `Book` クラス
- **役割**: ビジネスルールを持つ（貸し出し、返却など）

#### 値オブジェクト (Value Object)
- **特徴**: 値そのものを表現、不変、等価性で比較
- **例**: `Title`, `Author`, `ISBN`, `BookId`
- **役割**: バリデーションとドメインの表現力向上

#### リポジトリ (Repository)
- **特徴**: データの永続化を抽象化
- **例**: `BookRepositoryInterface`
- **役割**: ドメインオブジェクトの保存・取得

#### ユースケース (Use Case)
- **特徴**: アプリケーションでできることを表現
- **例**: `RegisterBookUseCase`
- **役割**: ビジネスフローの制御

### 4. 🎮 各層の責任

#### ドメイン層
```php
// ✅ やること
- ビジネスルールの実装
- エンティティと値オブジェクトの定義
- インターフェースの定義

// ❌ やらないこと
- データベースアクセス
- HTTPの処理
- フレームワーク依存の処理
```

#### アプリケーション層
```php
// ✅ やること
- ユースケースの実装
- ドメインオブジェクトの組み合わせ
- トランザクション制御

// ❌ やらないこと
- HTTPの詳細処理
- データベースの詳細
- ビジネスルールの実装
```

#### プレゼンテーション層
```php
// ✅ やること
- HTTPリクエストの受け取り
- レスポンスの返却
- 入力値の変換

// ❌ やらないこと
- ビジネスロジック
- データベースアクセス
- 複雑な計算
```

#### インフラ層
```php
// ✅ やること
- データベースアクセス
- 外部APIとの通信
- ファイルシステムアクセス

// ❌ やらないこと
- ビジネスルール
- アプリケーションフロー
```

### 5. 🧪 テスト容易性

#### ドメイン層のテスト
```php
// フレームワーク不要！
$book = new Book($id, $title, $author, $isbn);
$book->lend();
$this->assertFalse($book->isAvailable());
```

#### ユースケースのテスト
```php
// モックリポジトリを使用
$mockRepository = $this->createMock(BookRepositoryInterface::class);
$useCase = new RegisterBookUseCase($mockRepository);
```

### 6. 🔧 実装のポイント

#### 1. 値オブジェクトでバリデーション
```php
// 悪い例
if (empty($title)) {
    throw new Exception('タイトルが空です');
}

// 良い例
$title = new Title($title); // コンストラクタでバリデーション
```

#### 2. インターフェースをドメイン層に
```php
// ドメイン層
interface BookRepositoryInterface {
    public function save(Book $book): void;
}

// インフラ層
class EloquentBookRepository implements BookRepositoryInterface {
    // 実装
}
```

#### 3. コントローラーは薄く
```php
public function store(Request $request): JsonResponse
{
    // 1. コマンド作成
    $command = new RegisterBookCommand(...);
    
    // 2. ユースケース実行
    $response = $this->useCase->execute($command);
    
    // 3. HTTPレスポンス返却
    return response()->json($response->toArray());
}
```

### 7. 🚀 このアーキテクチャの利点

#### 変更容易性
- データベースをMySQLからPostgreSQLに変更 → インフラ層のみ変更
- WebからCLIアプリに変更 → プレゼンテーション層のみ変更

#### テスト容易性
- ドメイン層 → フレームワーク不要でテスト
- ユースケース → モックで外部依存を排除

#### 理解しやすさ
- ビジネスルールがドメイン層に集約
- 各層の責任が明確

### 8. 🎓 次のステップ

1. **集約 (Aggregate)** の概念を学ぶ
2. **ドメインサービス** を実装する
3. **ドメインイベント** を追加する
4. **CQRS** パターンを適用する
5. **バウンデッドコンテキスト** を設計する

### 9. 📝 ユビキタス言語の例

このプロジェクトで使用している用語：
- **本 (Book)**: 図書館で管理する書籍
- **貸し出し (Lend)**: 本を利用者に渡すこと
- **返却 (Return)**: 借りた本を図書館に戻すこと
- **利用可能 (Available)**: 貸し出し可能な状態
- **ISBN**: 本を一意に識別する番号

これらの用語は、ビジネス側（図書館員）とエンジニアが共通で使用します。

---

## 🎯 まとめ

クリーンアーキテクチャとDDDは、**変更に強く、テストしやすく、理解しやすい**システムを作るための設計手法です。

最初は複雑に感じるかもしれませんが、各層の責任を理解し、依存の向きを意識することで、保守性の高いアプリケーションが作れるようになります！
